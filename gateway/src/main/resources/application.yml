server:
  port: ${SERVER_PORT}

spring:
  application:
    name: api-gateway

  data:
    redis:
      host: ${SPRING_DATA_REDIS_HOST}
      port: ${SPRING_DATA_REDIS_PORT}

  cloud:
    gateway:
      routes:
        - id: user-service
          uri: ${USER_SERVICE_URL}
          predicates:
            - Path=/api/users/**,/api/auth/**
          filters:
            - name: RequestRateLimiter
              args:
                '[redis-rate-limiter.replenishRate]': ${RATE_LIMIT_AUTHENTICATED}
                '[redis-rate-limiter.burstCapacity]': ${RATE_LIMIT_AUTHENTICATED_BURST}
                '[redis-rate-limiter.requestedTokens]': 1
                key-resolver: "#{@userKeyResolver}"
            - name: CircuitBreaker
              args:
                name: userServiceCircuitBreaker
                fallbackUri: forward:/fallback/user-service

        - id: jwks
          uri: ${USER_SERVICE_URL}
          predicates:
            - Path=/.well-known/jwks.json

        - id: user-service-docs
          uri: ${USER_SERVICE_URL}
          predicates:
            - Path=/swagger-ui/**,/v3/api-docs/**

gateway:
  secret: ${GATEWAY_SECRET}
  rate-limit:
    authenticated:
      replenish-rate: ${RATE_LIMIT_AUTHENTICATED}
      burst-capacity: ${RATE_LIMIT_AUTHENTICATED_BURST}
    unauthenticated:
      replenish-rate: ${RATE_LIMIT_UNAUTHENTICATED}
      burst-capacity: ${RATE_LIMIT_UNAUTHENTICATED_BURST}

resilience4j:
  circuitbreaker:
    instances:
      userServiceCircuitBreaker:
        slidingWindowSize: 10
        minimumNumberOfCalls: 5
        failureRateThreshold: 50
        waitDurationInOpenState: 30000
        permittedNumberOfCallsInHalfOpenState: 3
        automaticTransitionFromOpenToHalfOpenEnabled: true
  timelimiter:
    instances:
      userServiceCircuitBreaker:
        timeoutDuration: 10s

management:
  endpoints:
    web:
      exposure:
        include: health,info,metrics,gateway
  endpoint:
    health:
      show-details: always
    gateway:
      access: unrestricted

logging:
  level:
    '[io.github.joaosimsic.gateway]': DEBUG
    '[org.springframework.cloud.gateway]': DEBUG
