services:
  api-gateway:
    build:
      context: .
      dockerfile: gateway/Dockerfile
    container_name: api-gateway
    ports:
      - "${GATEWAY_PORT}:${GATEWAY_PORT}"
    environment:
      SPRING_DATA_REDIS_HOST: ${GATEWAY_CACHE_HOST}
      SPRING_DATA_REDIS_PORT: ${REDIS_PORT}
      KC_JWKS_URL: ${KC_JWKS_URL}
      KC_JWT_ISSUER: ${KC_JWT_ISSUER}
      COGNITO_JWKS_URL: ${COGNITO_JWKS_URL}
      COGNITO_JWT_ISSUER: ${COGNITO_JWT_ISSUER}
      GATEWAY_JWT_EXPECTED_ISSUER: ${JWT_ISSUER}
      USER_SERVICE_URL: http://${USER_SERVICE_HOST}:${USER_SERVICE_PORT}
      CORS_ALLOWED_ORIGINS: ${FRONTEND_URL}
      RATE_LIMIT_AUTHENTICATED: ${RATE_LIMIT_AUTHENTICATED}
      RATE_LIMIT_AUTHENTICATED_BURST: ${RATE_LIMIT_AUTHENTICATED_BURST}
      RATE_LIMIT_UNAUTHENTICATED: ${RATE_LIMIT_UNAUTHENTICATED}
      RATE_LIMIT_UNAUTHENTICATED_BURST: ${RATE_LIMIT_UNAUTHENTICATED_BURST}
      CACHE_TTL_SECONDS: ${CACHE_TTL_SECONDS}
    depends_on:
      - user-cache
      - user-service

  gateway-cache:
    image: redis:7-alpine
    container_name: ${GATEWAY_CACHE_HOST}
    ports:
      - "${REDIS_PORT}:${REDIS_PORT}"
    volumes:
      - gateway_cache_data:/data

  user-service:
    build:
      context: .
      dockerfile: services/user-service/Dockerfile
    container_name: ${USER_SERVICE_HOST}
    ports:
      - "${USER_SERVICE_PORT}:${USER_SERVICE_PORT}"
    environment:
      SERVER_PORT: ${USER_SERVICE_PORT}
      APP_JWT_SECRET: ${GATEWAY_SECRET}
      SPRING_PROFILES_ACTIVE: ${USER_PROFILE}
      SPRING_DATASOURCE_URL: jdbc:postgresql://${USER_DB_HOST}:${POSTGRES_PORT}/${POSTGRES_NAME}
      SPRING_DATASOURCE_USERNAME: ${APP_USER}
      SPRING_DATASOURCE_PASSWORD: ${APP_PASSWORD}
      SPRING_FLYWAY_USER: ${FLYWAY_USER}
      SPRING_FLYWAY_PASSWORD: ${FLYWAY_PASSWORD}
      SPRING_DATA_REDIS_HOST: ${USER_CACHE_HOST}
      SPRING_DATA_REDIS_PORT: ${REDIS_PORT}
      SPRING_RABBITMQ_HOST: ${RABBITMQ_HOST}
      SPRING_RABBITMQ_PORT: ${RABBITMQ_PORT}
      SPRING_RABBITMQ_USERNAME: ${RABBITMQ_USERNAME}
      SPRING_RABBITMQ_PASSWORD: ${RABBITMQ_PASSWORD}
      SPRING_CLOUD_AWS_REGION_STATIC: ${AWS_DEFAULT_REGION}
      SPRING_CLOUD_AWS_CREDENTIALS_ACCESS_KEY: ${AWS_ACCESS_KEY_ID}
      SPRING_CLOUD_AWS_CREDENTIALS_SECRET_KEY: ${AWS_SECRET_ACCESS_KEY}
    depends_on:
      - user-db
      - rabbitmq

  user-db:
    image: postgres:16-alpine
    container_name: ${USER_DB_HOST}
    environment:
      POSTGRES_DB: ${POSTGRES_DB}
      POSTGRES_USER: ${POSTGRES_USER}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
    ports:
      - "${POSTGRES_PORT}:${POSTGRES_PORT}"
    volumes:
      - user_db_data:/var/lib/postgresql/data

  user-cache:
    image: redis:7-alpine
    container_name: ${USER_CACHE_HOST}
    ports:
      - "${REDIS_PORT}:${REDIS_PORT}"
    volumes:
      - user_cache_data:/data

  rabbitmq:
    image: rabbitmq:3-management-alpine
    container_name: ${RABBITMQ_HOST}
    ports:
      - "${RABBITMQ_PORT}:${RABBITMQ_PORT}"
      - "15672:15672"
    environment:
      RABBITMQ_DEFAULT_USER: ${RABBITMQ_USERNAME}
      RABBITMQ_DEFAULT_PASS: ${RABBITMQ_PASSWORD}
    volumes:
      - rabbitmq_data:/var/lib/rabbitmq

  keycloak:
    image: quay.io/keycloak/keycloak:24.0
    container_name: keycloak
    ports:
      - "${KEYCLOAK_PORT}:${KEYCLOAK_PORT}"
    environment:
      KEYCLOAK_ADMIN: ${KEYCLOAK_ADMIN_USERNAME}
      KEYCLOAK_ADMIN_PASSWORD: ${KEYCLOAK_ADMIN_PASSWORD}
      GITHUB_CLIENT_ID: ${GITHUB_CLIENT_ID}
      GITHUB_CLIENT_SECRET: ${GITHUB_CLIENT_SECRET}
    command: start-dev --import-realm
    volumes:
      - ./infrastructure/keycloak/realm-export.json:/opt/keycloak/data/import/realm-export.json

volumes:
  gateway_cache_data:
  user_db_data:
  user_cache_data:
  rabbitmq_data:
